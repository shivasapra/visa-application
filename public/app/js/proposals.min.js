function init_proposal_editor(){tinymce.remove("div.editable");var e=[];$.each(proposalsTemplates,function(o,t){e.push({url:admin_url+"proposals/get_template?name="+t,title:t})});var o={selector:"div.editable",inline:!0,theme:"inlite",relative_urls:!1,remove_script_host:!1,inline_styles:!0,verify_html:!1,cleanup:!1,apply_source_formatting:!1,valid_elements:"+*[*]",valid_children:"+body[style], +style[type]",file_browser_callback:elFinderBrowser,table_default_styles:{width:"100%"},fontsize_formats:"8pt 10pt 12pt 14pt 18pt 24pt 36pt",pagebreak_separator:'<p pagebreak="true"></p>',plugins:["advlist pagebreak autolink autoresize lists link image charmap hr","searchreplace visualblocks visualchars code","media nonbreaking table contextmenu","paste textcolor colorpicker"],autoresize_bottom_margin:50,insert_toolbar:"image media quicktable | bullist numlist | h2 h3 | hr",selection_toolbar:"save_button bold italic underline superscript | forecolor backcolor link | alignleft aligncenter alignright alignjustify | fontselect fontsizeselect h2 h3",contextmenu:"image media inserttable | cell row column deletetable | paste pastetext searchreplace | visualblocks pagebreak charmap | code",setup:function(e){e.addCommand("mceSave",function(){save_proposal_content(!0)}),e.addShortcut("Meta+S","","mceSave"),e.on("MouseLeave blur",function(){tinymce.activeEditor.isDirty()&&save_proposal_content()}),e.on("MouseDown ContextMenu",function(){is_mobile()||$("#small-table").hasClass("hide")||small_table_full_view()}),e.on("blur",function(){$.Shortcuts.start()}),e.on("focus",function(){$.Shortcuts.stop()})}};is_mobile()&&(o.theme="modern",o.mobile={},o.mobile.theme="mobile",o.mobile.toolbar=_tinymce_mobile_toolbar(),o.inline=!1,window.addEventListener("beforeunload",function(e){tinymce.activeEditor.isDirty()&&save_proposal_content()})),e.length>0&&(o.templates=e,o.plugins[3]="template "+o.plugins[3],o.contextmenu=o.contextmenu.replace("inserttable","inserttable template")),tinymce.init(o)}function add_proposal_comment(){var e=$("#comment").val();if(""!=e){var o={};o.content=e,o.proposalid=proposal_id,$("body").append('<div class="dt-loader"></div>'),$.post(admin_url+"proposals/add_proposal_comment",o).done(function(e){e=JSON.parse(e),$("body").find(".dt-loader").remove(),1==e.success&&($("#comment").val(""),get_proposal_comments())})}}function get_proposal_comments(){"undefined"!=typeof proposal_id&&requestGet("proposals/get_proposal_comments/"+proposal_id).done(function(e){$("body").find("#proposal-comments").html(e)})}function remove_proposal_comment(e){confirm_delete()&&requestGetJSON("proposals/remove_comment/"+e).done(function(o){1==o.success&&$('[data-commentid="'+e+'"]').remove()})}function edit_proposal_comment(e){var o=$("body").find('[data-proposal-comment-edit-textarea="'+e+'"] textarea').val();""!=o&&($.post(admin_url+"proposals/edit_comment/"+e,{content:o}).done(function(t){1==(t=JSON.parse(t)).success&&(alert_float("success",t.message),$("body").find('[data-proposal-comment="'+e+'"]').html(nl2br(o)))}),toggle_proposal_comment_edit(e))}function toggle_proposal_comment_edit(e){$("body").find('[data-proposal-comment="'+e+'"]').toggleClass("hide"),$("body").find('[data-proposal-comment-edit-textarea="'+e+'"]').toggleClass("hide")}function convert_template(e){var o,t=$(e).data("template");if("estimate"==t)o="estimate";else{if("invoice"!=t)return!1;o="invoice"}requestGet("proposals/get_"+o+"_convert_data/"+proposal_id).done(function(e){$(".proposal-pipeline-modal").is(":visible")&&$(".proposal-pipeline-modal").modal("hide"),$("#convert_helper").html(e),$("#convert_to_"+o).modal({show:!0,backdrop:"static"}),reorder_items()})}function save_proposal_content(e){var o=tinyMCE.activeEditor,t={};t.proposal_id=proposal_id,t.content=o.getContent(),$.post(admin_url+"proposals/save_proposal_data",t).done(function(t){t=JSON.parse(t),void 0!==e&&alert_float("success",t.message),o.save()}).fail(function(e){var o=JSON.parse(e.responseText);alert_float("danger",o.message)})}$(function(){get_proposal_comments(),$("body").on("click",".dismiss-proposal-convert-modal",function(e){e.preventDefault(),$("body").find(".proposal-convert-modal").modal("hide")})});